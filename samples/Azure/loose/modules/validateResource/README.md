# Module README

## Introduction

This module is used as a sample for resource validation.

It provides samples for an assert check and an error assert.

## Usage

The following is a usage example for storage accounts and MSSQL database.

```
// Validate storage account
module "validatesa" {
  source = "./modules/validateResource"
  objectsToValidate = {
    test1 = {
      resourceType = "storageaccount"
      resourceObj  = azurerm_storage_account.storageaccount
    }
  }
  depends_on = [
    azurerm_storage_account.storageaccount
  ]
}

// Validate databases
module "validatemssql" {
  source = "./modules/validateResource"
  objectsToValidate = {
    test1 = {
      resourceType = "mssql"
      resourceObj  = azurerm_mssql_database.serverdb
    }
  }
  depends_on = [
    azurerm_mssql_database.serverdb
  ]
}
```
## Assert examples

The check block will generate a warning only.

```
╷
│ Warning: Check block assertion failed
│ 
│   on modules/validateResource/modules/storageaccount/main.tf line 9, in check "resource_check":
│    9:     condition = alltrue([
│   10:       data.azurerm_storage_account.tocheck.name == "acheckrg" &&
│   11:       data.azurerm_storage_account.tocheck.account_tier == "Standard"
│   12:     ])
│     ├────────────────
│     │ data.azurerm_storage_account.tocheck.account_tier is "Standard"
│     │ data.azurerm_storage_account.tocheck.name is "checkrg"
│ 
│ Storage account failed validation
╵
```

The error case is generated by a `null_resource` check.

```
╷
│ Error: Invalid function argument
│ 
│   on modules/validateResource/modules/storageaccount/main.tf line 27, in resource "null_resource" "asserttest":
│   27:   ]) ? {} : file("Storage account failed validation")
│     ├────────────────
│     │ while calling file(path)
│ 
│ Invalid value for "path" parameter: no file exists at "Storage account failed validation"; this function works only with files that are distributed as part of
│ the configuration source code, so if this file will be created by a resource in this configuration you must instead obtain this result from an attribute of that
│ resource.
╵
```

The assert logic and conditions can be customised based on the conditions wanted.

## Notes
* The map can only have resource objects of the same type in a single invocation. You can use different invocations with different types, just not different types in the same invocation. This is a Terraform restriction. So, you can validate many objects of the same type in a single invocation, but not many objects of different types

## Requirements

No requirements.

## Providers

No providers.

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_mssqlvalidation"></a> [mssqlvalidation](#module\_mssqlvalidation) | ./modules/mssql | n/a |
| <a name="module_storagevalidation"></a> [storagevalidation](#module\_storagevalidation) | ./modules/storageaccount | n/a |

## Resources

No resources.

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_objectsToValidate"></a> [objectsToValidate](#input\_objectsToValidate) | n/a | <pre>map(object({<br>    resourceType = string<br>    resourceObj  = any<br>  }))</pre> | n/a | yes |

## Outputs

No outputs.
